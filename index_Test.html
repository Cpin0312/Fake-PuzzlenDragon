<!doctype html>
<html>
<head>
	<meta charset = 'utf-8'>
	<title>FakePuzzleAndDragon</title>
</head>
<script src = 'lib/commonMethod.js'></script>
<script src = 'lib/commonPIXI.js'></script>
<script src = 'lib/linq.js'></script>
<script src = 'lib/pixi.min.js'></script>
<script src = 'lib/pixi-layers.js'></script>
<script src = 'lib/soundjs-0.6.2.min.js'></script>
<script src = 'lib/tweenjs.min.js'></script>
<style>* {padding: 0; margin: 0}</style>
<body >
	<script type = 'text/javascript'>
    //initail Data
    var mapX =6;
    var mapY = 5;
    const DropSize = 80;
        
    var totalDrops = mapX * mapY;
    var comm = new commonMethod();
    var commPIXI = new commonPIXI(PIXI);
    var allDrops = [];
    var allCombo = []; 
    var app = new PIXI.Application(DropSize*mapX + 100,DropSize*mapY + 350,{backgroundColor :  comm.GetColor('Black')});
    document.body.appendChild(app.view);
        
    var groupFire = new PIXI.display.Group(1,false);
    var groupEarth = new PIXI.display.Group(2,false);
    var groupWater = new PIXI.display.Group(3,false);
    var groupLight = new PIXI.display.Group(4,false);
    var groupDark = new PIXI.display.Group(5,false);
    var groupDrag = new PIXI.display.Group(7,false);
    var groupText = new PIXI.display.Group(9,false);
    var groupTop = new PIXI.display.Group(10,false);
        
    app.stage = new PIXI.display.Stage();
    app.stage.addChild(new PIXI.display.Layer(groupFire));
    app.stage.addChild(new PIXI.display.Layer(groupEarth));
    app.stage.addChild(new PIXI.display.Layer(groupWater));
    app.stage.addChild(new PIXI.display.Layer(groupLight));
    app.stage.addChild(new PIXI.display.Layer(groupDark));
    app.stage.addChild(new PIXI.display.Layer(groupDrag));
    app.stage.addChild(new PIXI.display.Layer(groupText));
    app.stage.addChild(new PIXI.display.Layer(groupTop));
    
    var containRect = new PIXI.Container();
    var containText = new PIXI.Container();
    var containAll = new PIXI.Container();
    var containTop = new PIXI.Container();
        
    containAll.x = 0;
    containAll.y = 350;
    containAll.addChild(containRect);
    containAll.addChild(containText);
    app.stage.addChild(containAll);
    app.stage.addChild(containTop);
        
    createjs.Sound.alternateExtensions = ["mp3"];
    createjs.Sound.registerSound({src:"src/sounds/puzzleDragon_bmg.mp3", id:"sound"});
    createjs.Sound.registerSound({src:"src/sounds/drogMoveShort.mp3", id:"soundMove"});
    createjs.Sound.registerSound({src:"src/sounds/powerUp.mp3", id:"powerUp"});
    createjs.Sound.registerSound({src:"src/sounds/gameOver.mp3", id:"gameOverSound"});
    createjs.Sound.registerSound({src:"src/sounds/gameWin.mp3", id:"gameWin"});
    for(var i =0; i<27;i++)
    {
        var path =  'src/sounds/combo' + (i+1) + '.mp3' ;
        var id = 'combo' + (i+1);
        createjs.Sound.registerSound({src:path, id:id});
    }
        
    var dropFire ;
    var dropEarth ;
    var dropWater ;
    var dropLight ;
    var dropDark ;
    var audio;
    var HpBarLife;
    var HpBar;
    var hpBarMonster;
    var HpMonster;
    var gameOver;
    var monster ;
    var comboIcon ;
    var audioMoving ;
    let startTime ;
    let hpBoss ;
        
    var holdingTime = 80000;
    var countComboForText = 0;
    //Use for StandBy
    var refresh_1 = 0;
    //Calc for TextSprite
    var refresh_2 = 0;
    //
    var delay_1 = 0;
        
    let gameOverFlg = false; 
    let gameWinFlg = false; 
    var flgDragging = false;
    var flgMoving = false;
    var flgStartUp = true;
    //When Seleted drog hit with other drop, start countTime
    var flgStartMoving = false;
    //Start moving for new drops
    var flgMoveUptoDown = false;
        
    PIXI.loader
        .add('src/images/PuzzleDragons.json')
        .add('src/images/background.json')
        .add('src/images/topbackgroup.png')
        .add('src/images/monster.png')
        .add('src/images/mon_1.png')
        .add('src/images/HpBar.png')
        .add('src/images/HpBarLife.png')
        .add('src/images/hpBarMonster.png')
        .add('src/images/HpMonster.png')
        .add('src/images/9Combo.png')
        .add('src/images/gameOver.png')
        .add('src/images/clear.png')
        .add('src/images/egg.png')
        .load(setup);
        
    //BGM
    function handleLoadComplete(event)
    {
       audio = createjs.Sound.play("sound",{loop:-1});
    }
    //BGM Game Clear
    function handleLoadGameWin(event)
    {
       var gameWin = createjs.Sound.play("gameWin");
    }
    //BGM Drop move
    function handleMoving(event)
    {
       audioMoving = createjs.Sound.play("soundMove");
    }
    //BGM drop Remove  
    function handleRemove(event)
    {
        var id = 'combo'+ countComboForText;
        audioRemove = createjs.Sound.play(id);
        audioRemove.valume = 5.0;
    } 
    //BGM Combo Count 
    function handlePowerUp(event)
    {
       var audioPowerUp = createjs.Sound.play('powerUp');
    }
    //BGM Game Over
    function handleGameOver(event)
    {
       var gameOverSound = createjs.Sound.play('gameOverSound');
    }
        
    //StartUp Setting
    function setup()
    {
        //Play BackGroup BGM
        handleLoadComplete();   
        //set Battle BackGroup
        var topbackGroup = new PIXI.Sprite(PIXI.loader.resources["src/images/topbackgroup.png"].texture);
        topbackGroup.width = DropSize*mapX;
        topbackGroup.height = 325;
        topbackGroup.parentGroup = groupTop;
        containTop.addChild(topbackGroup);
        //set Monster
        monster = new PIXI.Sprite(PIXI.loader.resources["src/images/monster.png"].texture);
        monster.scale.x /= 2;
        monster.scale.y /= 2;
        monster.x = 90;
        monster.y = 20;
        monster.parentGroup = groupTop;
        containTop.addChild(monster);
        //set Fighter Member
        var monster_1 = new PIXI.Sprite(PIXI.loader.resources["src/images/mon_1.png"].texture);
        monster_1.scale.x /= 1.3;
        monster_1.scale.y /= 1.3;
        monster_1.x = 10;
        monster_1.y = 240;
        monster_1.parentGroup = groupTop;
        containTop.addChild(monster_1);
        //set Hp life(Discreace able)
        HpBarLife = new PIXI.Sprite(PIXI.loader.resources["src/images/HpBarLife.png"].texture);
        HpBarLife.width = 430;
        HpBarLife.x = 35;
        HpBarLife.y = 322;
        HpBarLife.parentGroup = groupTop;
        hpBoss = HpBarLife.width;
        containTop.addChild(HpBarLife);
        //set Hp life(Cover Only)
        HpBar = new PIXI.Sprite(PIXI.loader.resources["src/images/HpBar.png"].texture);
        HpBar.scale.x /= 1.35;
        HpBar.scale.y /= 1.3;
        HpBar.x = 10;
        HpBar.y = 322;
        HpBar.parentGroup = groupTop;
        containTop.addChild(HpBar);
        //set Monster hpBar(Discreace able)
        hpBarMonster = new PIXI.Sprite(PIXI.loader.resources["src/images/hpBarMonster.png"].texture);
        hpBarMonster.scale.x /= 1.35;
        hpBarMonster.scale.y /= 1.3;
        hpBarMonster.x = 90;
        hpBarMonster.y = 225;
        hpBarMonster.parentGroup = groupTop;
        containTop.addChild(hpBarMonster);
        //set Monster hpBar(Not Discreace able)
        HpMonster = new PIXI.Sprite(PIXI.loader.resources["src/images/HpMonster.png"].texture);
        HpMonster.scale.x /= 1.35;
        HpMonster.scale.y /= 1.3;
        HpMonster.x = 60;
        HpMonster.y = 213;
        HpMonster.parentGroup = groupTop;
        containTop.addChild(HpMonster);
        //Boss Skill Icon
        comboIcon = new PIXI.Sprite(PIXI.loader.resources["src/images/9Combo.png"].texture);
        comboIcon.x = 100;
        comboIcon.y = 50;
        comboIcon.parentGroup = groupTop;
        containTop.addChild(comboIcon);
        //Game Over scene
        gameOver = new PIXI.Sprite(PIXI.loader.resources["src/images/gameOver.png"].texture);
        gameOver.scale.x *= 1.5;
        gameOver.scale.y *= 1.5;
        //Game Clear scene
        clearStage = new PIXI.Sprite(PIXI.loader.resources["src/images/clear.png"].texture);
        //Egg scene
        egg = new PIXI.Sprite(PIXI.loader.resources["src/images/egg.png"].texture);
        //Drop Backgroup
        puzzleBackDround_Id = PIXI.loader.resources['src/images/background.json'].textures;
        //Game Scene Setting
        //BackGroup(Tiling)
        background = new PIXI.Texture(puzzleBackDround_Id['backGround.png']);
        tileBackGround = new PIXI.extras.TilingSprite(background,DropSize*mapX,DropSize*mapY);
        tileBackGround.tileScale.x *= 0.83;
        tileBackGround.tileScale.y *= 0.83;
        containAll.addChild(tileBackGround);
        app.stage.group.enableSort = true;
        //Drops
        puzzleDrops_Id = PIXI.loader.resources['src/images/PuzzleDragons.json'].textures;
        dropFire = puzzleDrops_Id['fire.png'];
        dropFire.IdGroup = 1;
        dropEarth = puzzleDrops_Id['earth.png'];
        dropEarth.IdGroup = 2;
        dropWater = puzzleDrops_Id['water.png'];
        dropWater.IdGroup = 3;
        dropLight = puzzleDrops_Id['light.png'];
        dropLight.IdGroup = 4;
        dropDark = puzzleDrops_Id['dark.png'];
        dropDark.IdGroup = 5;
        
        //First Time setting with no matching Page
        var flg = true;
        while(flg == true)
        {
            //Set DropPage
            SetDrop();
            //First Page would been 10combos able page
            getParentList = Enumerable.from(allDrops).select(xx=> xx.parentGroup).distinct().toArray();
            for(var i = 0; i < getParentList.length; i++)
            {
                getElementList = Enumerable.from(allDrops).where(xx=> xx.parentGroup == getParentList[i]).toArray();
                if(getElementList.length % 3 != 0)
                {
                    containRect.removeChildren();
                    allDrops = [];
                    break;
                }
            }
            if(allDrops.length == 0) continue;
            //Get Remove Able Combo
            allCombo = GetCombo();
            if(allCombo.length == 0)
            {
                //stop infinity Loop
                flg = false;
            }
            else
            {
                containRect.removeChildren();
                allDrops = [];
            }
        }
        gameLoop();
    }
        
    function SetDrop()
    {
        var ret = false;
        for(var i = 0;i<totalDrops;i++)
        {
            //Set Position
            var position_x = ((i%mapX) * DropSize) + (DropSize/2);
            var position_y = ((Math.floor(i/mapX)) * DropSize) + (DropSize/2);
            //get Random element
            var randomCnt = comm.GetRandomInt(1,5);
            var Drop;
            
            // Reset Id if drop exist
            if(allDrops.length > 0)
            {
                if(Enumerable.from(allDrops).count(xx=> xx.x ==position_x && xx.y == position_y ) > 0)
                {
                    var temp = Enumerable.from(allDrops).where(xx=> xx.x ==position_x && xx.y == position_y ).first();
                    temp.Id = i;
                    continue;
                }
            }
            // Set parentgroup
            if(randomCnt == dropFire.IdGroup)
            {
                Drop = new PIXI.Sprite(dropFire);
                Drop.parentGroup = groupFire;
            }
            // Set parentgroup
            else if(randomCnt == dropEarth.IdGroup)
            {
                Drop = new PIXI.Sprite(dropEarth);
                Drop.parentGroup = groupEarth;
            }
            // Set parentgroup
            else if(randomCnt == dropWater.IdGroup)
            {
                Drop = new PIXI.Sprite(dropWater);
                Drop.parentGroup = groupWater;
            }
            // Set parentgroup
            else if(randomCnt == dropLight.IdGroup)
            {
                Drop = new PIXI.Sprite(dropLight);
                Drop.parentGroup = groupLight;
            }
            // Set parentgroup
            else if(randomCnt == dropDark.IdGroup)
            {
                Drop = new PIXI.Sprite(dropDark);
                Drop.parentGroup = groupDark;
            }
            // Set parentgroup
            //Only first time (tranparent)
            if(flgStartUp == true) Drop.alpha = 0;
            //Add showable drop on page
            containRect.addChild(Drop);
            //Active after keyUp which have matched
            if(flgMoveUptoDown == true)
            {
                //MoveDown from top if drop have removed
                Drop.startY = position_y
                Drop.position.set(position_x,(DropSize/2) + position_y -  (mapY * DropSize));
            }
            else
            {
                //start up Only
                Drop.position.set(position_x,position_y);
            }
            //center point
            Drop.anchor.set(0.5);
            Drop.width = DropSize;
            Drop.height = DropSize;
            Drop.Id = i;
            //Set button event to each spirite
            subscribe(Drop);
            allDrops.push(Drop);
            ret = true;
        }
        return ret;

    }
        
    function gameLoop()
    {
        requestAnimationFrame(gameLoop);
        //Only First time
        if(flgStartUp == true)
        {
            //make tranparent drop to normal 
            if(Enumerable.from(containRect.children).count(xx=> xx.alpha < 1) > 0)
            {
                var list_Y = Enumerable.from(containRect.children).select(xx=> xx.y).distinct().orderByDescending().toArray();
                for(var i =0; i< list_Y.length;i++)
                {
                    var lisT = Enumerable.from(containRect.children).where(xx=> xx.y == list_Y[i] ).toArray();
                    for(var j =0; j< lisT.length;j++)
                    {
                        lisT[j].alpha += (i * 0.02) + 0.05;
                        if(lisT[j].alpha >= 1) lisT[j].alpha = 1;
                    }
                }
            }
            //reset flg
            else
            {
                flgStartUp = false;
            }
        }
        //Let drop move from up to down
        if(Enumerable.from(containRect.children).count(xx=> xx.startY > 0) > 0)
        {
            var ListY = Enumerable.from(containRect.children).where(xx=> xx.startY > 0).toArray();
            var Vertical = Enumerable.from(ListY).select(xx=> xx.y).distinct().orderByDescending().toArray();
            for(var i =0; i< Vertical.length;i++)
            {
                var lisT = Enumerable.from(ListY).where(xx=> xx.y == Vertical[i] ).toArray();
                for(var j =0; j< lisT.length;j++)
                {
                    if(lisT[j].y < lisT[j].startY)
                    {
                        lisT[j].y  += 25
                        if(lisT[j].y >= lisT[j].startY) 
                        {
                            lisT[j].y = lisT[j].startY;
                            lisT[j].startY = 0;
                        }
                    }
                }
            }
        }
        else
        {
            if(flgDragging == false)
            {
                //get maching Drop
                removeDrop();
            }
        }
        
        //set TextColor
        if(containText.children.length > 0)
        {
            delay_1 += 1;
            if(delay_1 % 6 == 0)
            {
                for(var  i = 0; i< containText.children.length ;i++)
                {
                    if(containText.children[i].style.fill == 'red')
                    {
                        containText.children[i] = SetmsgColor(containText.children[i],'white');
//                        containText.children[i].style = {fill: 'white'};
                    }
                    else
                    {
                        containText.children[i] = SetmsgColor(containText.children[i],'red');
//                        containText.children[i].style = {fill: 'red'};
                    }
                }
            }
        }
        
        //Game OverFlg
        if(HpBarLife.width <= 0 )
        {
           audio.paused = true;
            if(gameOverFlg == false)handleGameOver();
            if(containRect.children[0].alpha > 0)
            {
                for(var i = 0; i<containRect.children.length; i ++ )
                {
                    containRect.children[i].alpha -= 0.1;
                }
            }
            gameOver.parentGroup = groupTop;
            gameOver.x = 80;
            gameOver.y = 530;
            containTop.addChild(gameOver);
            gameOverFlg = true;
        }
        //if over 9combos 
        if(countComboForText > 9 && containText.children == 0)
        {
            if(containRect.children[0].alpha > 0.5)
            {
                for(var i = 0; i<containRect.children.length; i ++ )
                {
                    containRect.children[i].alpha -= 0.5;
                }
            }
            hpBarMonster.width -= 10;
            if(hpBarMonster.width <= 10)
            {
                hpBarMonster.width = 0;
                countComboForText = 0;
                gameWinFlg = true;
            }
        }
        // if win the game
        if(gameWinFlg == true && hpBarMonster.width <= 10)
        {
            //monster been transparent
            if(monster.alpha !=0)
            {
                monster.alpha -= 0.1;
                if(monster.alpha < 0.1 )
                {
                    HpMonster.width = 0;
                    monster.alpha = 0;
                    comboIcon.alpha = 0;
                    audio.paused = true;
                    egg.parentGroup = groupTop;
                    egg.alpha = 0;
                    egg.x = 200;
                    egg.y = 150;
                    containTop.addChild(egg);
                    
                }
            }
            else
            {
                //Show egg
                egg.alpha += 0.1;
                if(egg.alpha >= 1)
                {
                    handleLoadGameWin();
                    clearStage.parentGroup = groupTop;
                    
                    clearStage.scale.x *= 0.8;
                    clearStage.scale.y *= 0.8;
                    clearStage.x = 60;
                    clearStage.y = 50;
                    containTop.addChild(clearStage);
                    gameWinFlg = false;
                    flgStartMoving = true;
                }
            }
        }
    }
        
    function SetmsgColor(textSprite,color)
    {
        var sprite_Text = textSprite;
        sprite_Text.style = {
            fontFamily: "BauHaus 93",
            fontSize: 24,
            fill: color,
            stroke: '#000000',
            strokeThickness: 4,
        };
        return sprite_Text;
    }
        
    //Set Mouse Event
    function subscribe(obj)
    {
        obj.interactive = true;
        obj.buttonMode= true;
        obj.on('pointerdown',dragDown);
        obj.on('pointerup',dragUp);
        obj.on('pointermove',dragMove);
    }
    // MouseClick
    function dragDown(event)
    {
        if(flgStartMoving == true) return ;
        if(this.flgDragging != true && flgStartUp == false)
        {
            
            startTime = new Date();
            countComboForText = 0;
            flgMoveUptoDown = false;
            flgDragging = true;
            this.flgDragging = true;
            this.data = event.data;
            this.scale.x *= 1.1;
            this.scale.y *= 1.1;
            this.org_parentGroup = this.parentGroup;
            this.parentGroup = groupDrag;
            this.org_position_x = this.x;
            this.org_position_y = this.y;
            this.org_Id = this.Id;
            var mousePst = this.data.getLocalPosition(this.parent);
            this.position.set(mousePst.x,mousePst.y);
        }
    }
    //Mouse Unclick
    function dragUp()
    {
        if(this.flgDragging == true)
        {   
            this.scale.x /= 1.1;
            this.scale.y /= 1.1;
            this.parentGroup = this.org_parentGroup;
            this.x = this.org_position_x;
            this.y = this.org_position_y;
            this.flgDragging = false;
            flgDragging = false  ;
            flgMoveUptoDown = true;
        }
    }
    //Mouse Move
    function dragMove(e)
    {
       if(this.flgDragging == true)
        {
            const timeNow = new Date();
            var mousePst = this.data.getLocalPosition(this.parent);
            this.position.set(mousePst.x,mousePst.y);
            var result = hitDrop(this,allDrops);
            if( result != undefined)
            {
                handleMoving();
                if(audioMoving.playState == 'playFinished')
                {
                    handleMoving();
                }
                result.org_Id = result.Id;
                this.org_Id = this.Id;
                result.Id = this.Id;
                this.Id = result.org_Id
                result.org_position_x = result.x ;
                result.org_position_y = result.y ;
                result.x = this.org_position_x;
                result.y = this.org_position_y;
                this.org_position_x = result.org_position_x;
                this.org_position_y = result.org_position_y;
                flgStartMoving = true;
            }
            if(timeNow - startTime >holdingTime )
            {
                e.stopPropagation();
                this.scale.x /= 1.1;
                this.scale.y /= 1.1;
                this.parentGroup = this.org_parentGroup;
                this.x = this.org_position_x;
                this.y = this.org_position_y;
                this.flgDragging = false;
                flgDragging = false  ;
                flgMoveUptoDown = true;

            }
        }
    }
    
    //Calculate drop with have mmatched or not
    function hitDrop(draggedDrop,arryDrop)
    {
        var thisDrop = draggedDrop;
        var arryDrop = arryDrop;
        thisDrop.top_Left = new PIXI.Point(thisDrop.x - (thisDrop.width/4) ,thisDrop.y - (thisDrop.height/4) );
        thisDrop.top_Right = new PIXI.Point(thisDrop.x + (thisDrop.width/4) ,thisDrop.top_Left.y);
        thisDrop.bottom_Left = new PIXI.Point(thisDrop.top_Left.x,thisDrop.y + (thisDrop.height/4) );
        thisDrop.bottom_Right = new PIXI.Point(thisDrop.top_Right.x,thisDrop.bottom_Left.y);
        var returnDrop = undefined;
        
        for(var i=0; i< arryDrop.length;i++)
        {
            var targetDrop = arryDrop[i];
            
            if(thisDrop.Id == targetDrop.Id )　continue;
            targetDrop.top_Left = new PIXI.Point(targetDrop.x - (targetDrop.width/4),targetDrop.y - (targetDrop.height/4) );
            targetDrop.top_Right = new PIXI.Point(targetDrop.x + (targetDrop.width/4),targetDrop.top_Left.y);
            targetDrop.bottom_Left = new PIXI.Point(targetDrop.top_Left.x,targetDrop.y + (targetDrop.height/4) );
            targetDrop.bottom_Right = new PIXI.Point(targetDrop.top_Right.x,targetDrop.bottom_Left.y);
            
            if(thisDrop.top_Left.x >= targetDrop.top_Left.x && 
               thisDrop.top_Left.x <= targetDrop.top_Right.x && 
               thisDrop.top_Left.y >= targetDrop.top_Left.y && 
               thisDrop.top_Left.y <= targetDrop.bottom_Left.y)
            {
                return targetDrop;
               break;
            }
            else if(thisDrop.top_Right.x >= targetDrop.top_Left.x && 
                    thisDrop.top_Right.x <= targetDrop.top_Right.x &&
                    thisDrop.top_Right.y >= targetDrop.top_Left.y &&
                    thisDrop.top_Right.y <= targetDrop.bottom_Left.y) 
            {
                return targetDrop;
               break;
            }
            else if(thisDrop.bottom_Left.x >= targetDrop.top_Left.x && 
                    thisDrop.bottom_Left.x <= targetDrop.top_Right.x &&
                    thisDrop.bottom_Left.y >= targetDrop.top_Left.y &&
                    thisDrop.bottom_Left.y <= targetDrop.bottom_Left.y) 
            {
                return targetDrop;
               break;
            }
            else if(thisDrop.bottom_Right.x >= targetDrop.top_Left.x &&
                    thisDrop.bottom_Right.x <= targetDrop.top_Right.x &&
                    thisDrop.bottom_Right.y >= targetDrop.top_Left.y &&
                    thisDrop.bottom_Right.y <= targetDrop.bottom_Left.y) 
            {
                return targetDrop;
               break;
            }
        }
        return undefined;
    }
    
    //Get combo(Total)
    function GetCombo()
    {
        if(allDrops.length == 0) 
        {
            var Ary = [];
            return Ary;
        }
        allDrops = Enumerable.from(allDrops).orderByDescending(xx=> xx.y).thenBy(xx=>xx.x).toArray();
        var listComboX = getHorizonCombo();
        var listComboY = getVerticalCombo();
        var listNearComboX = getNearComboX(listComboX);
        var listNearComboY = getNearComboY(listComboY);
        var comboList = getLinkCombo(listNearComboX,listNearComboY);
        return comboList;
        
    }
    //getHorizonCombo
    function getHorizonCombo()
    {
        //Get All List Horizon
        var GetXList = Enumerable.from(allDrops).select(xx=>xx.y).distinct().orderByDescending().toArray();
        var List_x = [];
        for(var i = 0; i< GetXList.length;i++)
        {
            var xList = Enumerable.from(allDrops).where(xx=> xx.y == GetXList[i]).orderBy(xx=> xx.x).toArray();
            List_x.push(xList);
        }
        //SetCombo each XList
        var ListCombo_x = [];
        for(var i = 0 ;i<List_x.length;i++)
        { 
            var currentList = List_x[i];
            var GetXListParent = Enumerable.from(currentList).select(xx=> xx.parentGroup).distinct().toArray();
            for(var j = 0; j<GetXListParent.length;j++)
            {
                var currentParentGroup = GetXListParent[j];
                var cnt = Enumerable.from(currentList).count(xx=> xx.parentGroup == currentParentGroup);
                if(cnt < 3)
                {
                    continue;
                }
                var ListNOw = Enumerable.from(currentList).where(xx=> xx.parentGroup == currentParentGroup).toArray();
                var comboList = [];
                for(var k = 0; k<ListNOw.length;k++ )
                {
                    var thisDrop = ListNOw[k];
                    if(comboList.length < 1)
                    {
                        comboList.push(thisDrop);
                        continue;
                    }
                    if(thisDrop.x - comboList[comboList.length - 1].x >= DropSize + (DropSize/2))
                    {
                        if(comboList.length >= 3)
                        {
                            comboList.parentGroup = currentParentGroup;
                            ListCombo_x.push(comboList);
                            comboList = [];
                        }
                        else
                        {
                            comboList = [];
                        }
                        if(ListNOw.length - k < 3)break;
                        comboList.push(thisDrop);
                    }
                    else
                    {
                        comboList.push(thisDrop);
                    }
                    if(ListNOw.length - (k+1) == 0 && comboList.length >= 3)
                    {
                        comboList.parentGroup = currentParentGroup;
                        ListCombo_x.push(comboList);
                    }
                }
            }
        }
        return ListCombo_x;
    }
    //getVerticalCombo
    function getVerticalCombo()
    {
        //SetCombo each YList
        //Get all list Vertical
        var GetYList = Enumerable.from(allDrops).select(xx=>xx.x).distinct().orderBy().toArray();
        var List_y = [];
        for(var i = 0; i< GetYList.length;i++)
        {
            var yList = Enumerable.from(allDrops).where(xx=> xx.x == GetYList[i]).orderByDescending(xx=> xx.y).toArray();
            List_y.push(yList);
        }
        var ListCombo_y = [];
        for(var i = 0 ;i<List_y.length;i++)
        { 
            var currentList = List_y[i];
            var GetYListParent = Enumerable.from(currentList).select(xx=> xx.parentGroup).distinct().toArray();
            for(var j = 0; j<GetYListParent.length;j++)
            {
                var currentParentGroup = GetYListParent[j];
                var cnt = Enumerable.from(currentList).count(xx=> xx.parentGroup == currentParentGroup);
                if(cnt < 3)
                {
                    continue;
                }
                var ListNOw = Enumerable.from(currentList).where(xx=> xx.parentGroup == currentParentGroup).toArray();
                var comboList = [];
                for(var k = 0; k<ListNOw.length;k++ )
                {
                    var thisDrop = ListNOw[k];
                    if(comboList.length < 1)
                    {
                        comboList.push(thisDrop);
                        continue;
                    }
                    if(comboList[comboList.length - 1].y - thisDrop.y >= DropSize + (DropSize/2))
                    {
                        if(comboList.length >= 3)
                        {
                            comboList.parentGroup = currentParentGroup;
                            ListCombo_y.push(comboList);
                            comboList = [];
                        }
                        else
                        {
                            comboList = [];
                        }
                        if(ListNOw.length - k < 3)break;
                        comboList.push(thisDrop);
                    }
                    else
                    {
                        comboList.push(thisDrop);
                    }
                    if(ListNOw.length - (k+1) == 0 && comboList.length >= 3)
                    {
                        comboList.parentGroup = currentParentGroup;
                        ListCombo_y.push(comboList);
                    }
                }
            }
        }
        return ListCombo_y;
    }
        
    //Calculate drop with have matched or not(array Type)
    function getMatching2Array(arry1,arry2)
    {
        var IRtn = undefined; 
        for(var i=0;i<arry2.length;i++)
        {
            var cnt = Enumerable.from(arry1).count(xx=> xx == arry2[i]);
            if(cnt > 0) 
            {
                IRtn = arry2[i];
                break;
            }
        }
        return IRtn;
    }
    
    //getNearComboX
    function getNearComboX(arryX)
    {
        //GetNearCombo
        var allParent = Enumerable.from(arryX).select(xx=> xx.parentGroup).distinct().toArray();
        var listNearX = [];
        for(var i = 0; i < allParent.length;i++)
        {
            var combo = Enumerable.from(arryX).where(xx=> xx.parentGroup == allParent[i]).toArray();
            if(combo.length == 1)
            {
                combo[0].parentGroup = allParent[i];
                listNearX.push(combo[0]);
                continue;
            }
            var multiCombo = [];
            for(var j = 0; j<combo.length;j++)
            {
                var currentCombo = combo[j];
                if(multiCombo.length < 1)
                {
                    currentCombo.parentGroup = allParent[i];
                    multiCombo.push(currentCombo)
                }
                else
                {
                    for(var k=0; k<multiCombo.length;k++)
                    {
                        var listYPoint = Enumerable.from(multiCombo[k]).select(xx=> xx.y).orderBy().first();
                        var currentYpoint = Enumerable.from(currentCombo).select(xx=> xx.y).orderBy().first();
                        if(listYPoint ==currentYpoint)
                        {
                            currentCombo.parentGroup = allParent[i];
                            multiCombo.push(currentCombo);
                            break;
                        }
                        if( listYPoint - currentYpoint > 120 )
                        {
                            if(multiCombo.length == k + 1)
                            {
                                currentCombo.parentGroup = allParent[i];
                                multiCombo.push(currentCombo);
                                break;
                            }
                            else
                            {
                                continue;
                            }

                        }
                        var listCombo = Enumerable.from(multiCombo[k]).select(xx=> xx.x).toArray();
                        var current = Enumerable.from(currentCombo).select(xx=> xx.x).toArray();
                        var match = getMatching2Array(listCombo,current);
                        if(match != undefined)
                        {
                            var combineCombo = multiCombo[k].concat(currentCombo);
                            multiCombo = Enumerable.from(multiCombo).where(xx=> xx != multiCombo[k]).toArray();
                            multiCombo = Enumerable.from(multiCombo).where(xx=> xx != currentCombo).toArray();
                            combineCombo.parentGroup = allParent[i];
                            multiCombo.push(combineCombo);
                            break;
                        }
                        else
                        {
                            currentCombo.parentGroup = allParent[i];
                            multiCombo.push(currentCombo);
                        }
                    }   
                }
            }
            if(multiCombo.length > 0)
            {
                multiCombo = Enumerable.from(multiCombo).distinct().toArray();
                for(var xx= 0; xx< multiCombo.length;xx++)
                {
                    listNearX.push(multiCombo[xx]);
                }
            }
        }
        for(var i = 0; i< listNearX.length;i++)
        {
            listNearX[i].x = Enumerable.from(listNearX[i]).select(xx=> xx.x).orderBy().first();
            listNearX[i].y = Enumerable.from(listNearX[i]).select(xx=> xx.y).orderByDescending().first();
        }
        listNearX = Enumerable.from(listNearX).orderByDescending(xx=> xx.y).thenBy(xx=>xx.x).toArray();
        return listNearX;
    }
        
    //getNearComboY
    function getNearComboY(arryY)
    {
        //GetNearCombo
        var allParent = Enumerable.from(arryY).select(xx=> xx.parentGroup).distinct().toArray();
        var listNearY = [];
        for(var i = 0; i < allParent.length;i++)
        {
            var combo = Enumerable.from(arryY).where(xx=> xx.parentGroup == allParent[i]).toArray();
            if(combo.length == 1)
            {
                combo[0].parentGroup = allParent[i];
                listNearY.push(combo[0]);
                continue;
            }
            var multiCombo = [];
            for(var j = 0; j<combo.length;j++)
            {
                var currentCombo = combo[j];
                if(multiCombo.length < 1)
                {
                    currentCombo.parentGroup = allParent[i];
                    multiCombo.push(currentCombo)
                }
                else
                {
                    for(var k=0; k<multiCombo.length;k++)
                    {
                        var listXpoint = Enumerable.from(multiCombo[k]).select(xx=> xx.x).orderByDescending().first();
                        var currentXpoint = Enumerable.from(currentCombo).select(xx=> xx.x).orderBy().first();
                        if(listXpoint ==currentXpoint)
                        {
                            currentCombo.parentGroup = allParent[i];
                            multiCombo.push(currentCombo);
                            break;
                        }
                        if( currentXpoint - listXpoint  > 120 )
                        {
                            if(multiCombo.length == k + 1)
                            {
                                currentCombo.parentGroup = allParent[i];
                                multiCombo.push(currentCombo);
                                break;
                            }
                            else
                            {
                                continue;
                            }

                        }
                        var listCombo = Enumerable.from(multiCombo[k]).select(xx=> xx.y).toArray();
                        var current = Enumerable.from(currentCombo).select(xx=> xx.y).toArray();
                        var match = getMatching2Array(listCombo,current);
                        if(match != undefined)
                        {
                            var combineCombo = multiCombo[k].concat(currentCombo);
                            multiCombo = Enumerable.from(multiCombo).where(xx=> xx != multiCombo[k]).toArray();
                            multiCombo = Enumerable.from(multiCombo).where(xx=> xx != currentCombo).toArray();
                            combineCombo.parentGroup = allParent[i];
                            multiCombo.push(combineCombo);
                            break;
                        }
                        else
                        {
                            currentCombo.parentGroup = allParent[i];
                            multiCombo.push(currentCombo);
                        }
                    }   
                }
            }
            if(multiCombo.length > 0)
            {
                multiCombo = Enumerable.from(multiCombo).distinct().toArray();
                for(var xx= 0; xx< multiCombo.length;xx++)
                {
                    listNearY.push(multiCombo[xx]);
                }
            }
        }
        for(var i = 0; i< listNearY.length;i++)
        {
            listNearY[i].x = Enumerable.from(listNearY[i]).select(xx=> xx.x).orderBy().first();
            listNearY[i].y = Enumerable.from(listNearY[i]).select(xx=> xx.y).orderByDescending().first();
        }
        listNearY = Enumerable.from(listNearY).orderByDescending(xx=> xx.y).thenBy(xx=>xx.x).toArray();
        return listNearY;
    }
    
    //getLinkCombo
    function getLinkCombo(arryX,arryY)
    {
        //Get Link Combo
        var ListJoinXYCombo = arryX.concat(arryY);
        for(var i = 0; i< ListJoinXYCombo.length;i++)
        {
            ListJoinXYCombo[i].x = Enumerable.from(ListJoinXYCombo[i]).select(xx=> xx.x).orderBy().first();
            ListJoinXYCombo[i].y = Enumerable.from(ListJoinXYCombo[i]).select(xx=> xx.y).orderByDescending().first();
        }
        ListJoinXYCombo = Enumerable.from(ListJoinXYCombo).orderByDescending(xx=> xx.y).thenBy(xx=>xx.x).toArray();
        var allParent = Enumerable.from(ListJoinXYCombo).select(xx=> xx.parentGroup).distinct().toArray();
        var comboList = [];
        for(var i = 0; i < allParent.length;i++)
        {
            var currentList = Enumerable.from(ListJoinXYCombo).where(xx=> xx.parentGroup == allParent[i]).toArray();
            var multiCombo = [];
            for(var j=0;j < currentList.length;j++)
            {
                var currentCombo = currentList[j];
                if(multiCombo.length == 0)
                {
                    currentCombo.parentGroup = allParent[i];
                    multiCombo.push(currentCombo)
                }
                else
                {
                    for(var k = 0; k<multiCombo.length;k++ )
                    {
                        var ListId = Enumerable.from(multiCombo[k]).select(xx=> xx.Id).distinct().toArray();
                        var currentId= Enumerable.from(currentCombo).select(xx=> xx.Id).distinct().toArray();
                        var ret = getMatching2Array(ListId,currentId);
                        if(ret != undefined)
                        {
                            var combineCombo = multiCombo[k].concat(currentCombo);
                            multiCombo = Enumerable.from(multiCombo).where(xx=> xx != multiCombo[k]).toArray();
                            multiCombo = Enumerable.from(multiCombo).where(xx=> xx != currentCombo).toArray();
                            combineCombo.parentGroup = allParent[i];
                            multiCombo.push(combineCombo);
                            break;
                        }
                        else
                        {
                            currentCombo.parentGroup = allParent[i];
                            multiCombo.push(currentCombo);
                            break;
                        }
                    }
                }
            }
            if(multiCombo.length > 0)
            {
                multiCombo = Enumerable.from(multiCombo).distinct().toArray();
                for(var xx= 0; xx< multiCombo.length;xx++)
                {
                    comboList.push(multiCombo[xx]);
                }
            }
        }
        
        var allParent = Enumerable.from(comboList).select(xx=> xx.parentGroup).distinct().toArray(); 
        for(var z = 0; z < mapY;z++)
        {
            for(var i = 0; i < allParent.length;i++)
            {
                var currentList = Enumerable.from(comboList).where(xx=> xx.parentGroup == allParent[i]).toArray();
                var loop = currentList.length;
                for(var j=0;j <loop ;j++)
                {
                    var next = j + 1;
                    if(next == loop)
                    {
                        next = j;
                    }
                    var ListId = Enumerable.from(currentList[j]).select(xx=> xx.Id).distinct().toArray();
                    var currentId= Enumerable.from(currentList[next]).select(xx=> xx.Id).distinct().toArray();
                    var ret = getMatching2Array(ListId,currentId);
                    if(ret != undefined && next!= j)
                    {
                        var combineCombo = currentList[j].concat(currentList[next]);
                        comboList = Enumerable.from(comboList).where(xx=> xx != currentList[j]).toArray();
                        comboList = Enumerable.from(comboList).where(xx=> xx != currentList[next]).toArray();
                        combineCombo.parentGroup = allParent[i];
                        comboList.push(combineCombo);
                        break;
                    }
            }
        }
        for(var i = 0; i< comboList.length;i++)
        {
            comboList[i].x = Enumerable.from(comboList[i]).select(xx=> xx.x).orderBy().first();
            comboList[i].y = Enumerable.from(comboList[i]).select(xx=> xx.y).orderByDescending().first();
        }
        comboList = Enumerable.from(comboList).orderByDescending(xx=> xx.y).thenBy(xx=>xx.x).toArray();
        return comboList;
        }
    }
    //ResetPosition
    function ResetPosition(arry)
    {
        var objList = arry;
        var listX = Enumerable.from(arry).select(xx=>xx.x).distinct().orderBy().toArray();
        for(var i =0;i< listX.length; i++)
        {
            var list = Enumerable.from(arry).where(xx=>xx.x == listX[i]).toArray();
            list = Enumerable.from(list).orderByDescending(xx=>xx.y).toArray();
            if(list.length == mapY) continue;
            for(var k = 0; k < list.length;k++)
            {
                for(var j =0;j<mapY;j++)
                {
                    var pointY = (((mapY-1) - j) * DropSize) + (DropSize/2);
                    
                    var minHeight = Enumerable.from(list).select(xx => xx.y).distinct().orderBy().first(); 
                    var minHeight_2 = 999;
                    if(Enumerable.from(list).count(xx => xx.moveTarget != undefined)> 0)
                    {
                        minHeight_2 = Enumerable.from(list).where(xx => xx.moveTarget != undefined).select(xx => xx.moveTarget).orderBy().first();
                    }
                    minHeight = (minHeight > minHeight_2)? minHeight_2:minHeight;
                    
                    if(minHeight > pointY) break;
                    if(list[k].y == pointY) break;
                    
                    if(Enumerable.from(list).count(xx => xx.y == pointY && xx.moveTarget == undefined ) > 0) continue;
                    if(Enumerable.from(list).count(xx => xx.moveTarget == pointY) > 0) continue;
                    
                    if(list[k].moveTarget == pointY) break;
                    
                    list[k].moveTarget = pointY;
                    break;
                }
            }
        }
    }
     //removeDrop   
    function removeDrop()
    {
        if(flgMoving == false)
        {
            allCombo = GetCombo();
        }
        if(allCombo.length > 0)
        {
            for(var i = 0; i<allCombo.length;i++ )
            {
                if(allCombo[i][0].alpha == 1)
                {
//                   cntCombo += 1;
                    countComboForText += 1;
                   handleRemove();
                }
                for(var j = 0;j <allCombo[i].length;j++)
                {
                    allCombo[i][j].alpha -= 0.04; 
                }
                if(allCombo[i][0].alpha > 0) return;  
//                countComboForText += 1;
                for(var j = 0;j <allCombo[i].length;j++)
                {
                    containRect.removeChild(allCombo[i][j])
                    allDrops = Enumerable.from(allDrops).where(xx=> xx !=allCombo[i][j] ).toArray();
                    allDrops = Enumerable.from(allDrops).distinct().toArray();
                }
                var xList = Enumerable.from(allCombo[i]).select(xx=> xx.x).distinct().orderBy().toArray();
                var yList = Enumerable.from(allCombo[i]).select(xx=> xx.y).distinct().orderBy().toArray();
                var pointX =  xList[0] + ((xList[xList.length-1] - xList[0]) / 2);
                var pointY = yList[0] + ((yList[yList.length-1] - yList[0]) / 2);
                var txt = countComboForText + ' combos';
                var msg = commPIXI.Setmsg(txt,pointX,pointY);
                msg.parentGroup = groupText;
                msg.Id = countComboForText;
                containText.addChild(msg);
            }
            allCombo = [];            

        }
              
        if(allCombo.length == 0 && containText.children.length > 0  && allDrops.length == (mapX*mapY) )
        {
//            if(refresh_1 < 30)
//            {
//                //need to refresh page
//                refresh_1 += 1;
//                return;
//            }
            containText.children = Enumerable.from(containText.children).orderBy(xx=> xx.Id).toArray();
            if(refresh_2 == 0)
            {
                containText.children[0].scale.x *= 1.5;
                containText.children[0].scale.y *= 1.5;
            }
            if(refresh_2 < 30)
            {
                //need to refresh page
                refresh_2 += 1;
                if(refresh_2== 5)
                {
                    handlePowerUp();
                }
                return;
            }
            containText.removeChild(containText.children[0]);
            
            if(containText.children.length == 0 )
            {
                flgStartMoving = false;
            }
            
            if(containText.children.length == 0 && countComboForText < 10)
            {
                HpBarLife.width  -= hpBoss/5;   
            }
            refresh_2 = 0;
            return;
               
        }  

        if(allDrops.length <  (mapX*mapY) )
        { 
            if( Enumerable.from(allDrops).count(xx=> xx.moveTarget != undefined)== 0)
            {
                ResetPosition(allDrops);
            }
            if( Enumerable.from(allDrops).count(xx=> xx.moveTarget != undefined)> 0)
            {
                flgMoving = true;
                var move = Enumerable.from(allDrops).where(xx=> xx.moveTarget != undefined).toArray();
                for(var i = 0; i<move.length;i++)
                {
                    if(move[i].y + 20 < move[i].moveTarget)
                    {
                        move[i].y += 10;
                    }
                    else
                    {
                        move[i].y= move[i].moveTarget;
                        move[i].moveTarget= undefined;
                    }
                }
            }
            else
            {
                flgMoving = false;
                var flg = SetDrop();
                allCombo = GetCombo();
            }
        }
    }
        
     
	</script>
</body>
</html>